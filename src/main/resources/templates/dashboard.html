<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>SmartGate Dashboard</title>
	  <link rel="stylesheet" href="/css/output.css">
	  <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/sweetalert2.min.css">
	<script src="/js/sweetalert2.min.js"></script>
	<script src="/js/jquery.min.js"></script>
	<script src="/js/popper.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/js/jquery-3.6.0.js"></script>
	<script src="/js/jquery-3.6.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
		   <!-- Add Highcharts library -->
		   <script src="https://code.highcharts.com/highcharts.js"></script>
		   

</head>

<body class="flex flex-col h-screen bg-gray-00 animate-fade-in">
    

    <!-- Wrapper for Sidebar and Top Bar -->
    <div class="flex animate-fade-in-delay">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar bg-gray-800 text-white flex flex-col animate-fade-in">
            <div class="p-4 flex items-center justify-between sidebar-logo logo-border relative">
                <div class="flex items-center">
                    <img th:src="@{${'/display?id=' + session.currentUser.id}}" alt="Logo" class="h-8 w-8 mr-2">
                    <span class="font-bold text-lg hidden sidebar-expanded">SMARTGATE</span>
                </div>
            </div>
			<a th:href="@{/getProfile}" class="flex items-center mt-6 px-4 space-x-3 pb-4 hover:bg-gray-700 rounded transition duration-300">
					    <!-- Corrected th:src attribute -->
					    <img th:src="@{'/display?id=' + ${session.currentUser.id}}" alt="User Profile" class="h-12 w-12 rounded-full cursor-pointer">
					    <div class="profile-info">
					      <p class="font-semibold hidden sidebar-expanded" th:text="${session.currentUser.fullname}"></p>
			                   <p class="text-sm text-gray-400 hidden sidebar-expanded" th:text="${session.currentUser.userType}"></p>
					    </div>
					</a>
            <nav class="flex-1 mt-10 space-y-2 px-4">
                <a th:href="@{/getDashboard}" class="sidebar-nav-item flex items-center p-2 text-white bg-purple-600 rounded group">
                    <i class="fas fa-tachometer-alt mr-3"></i><span>DASHBOARD</span>
                    <span class="tooltip">DASHBOARDS</span>
                </a>
                <a th:if="${session.currentUser.userType != 'guard' && session.currentUser.userType != 'departmenthead'}" th:href="@{/getUsers}" class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
                    <i class="fas fa-users mr-3"></i><span>USER MANAGEMENT</span>
                    <span class="tooltip">USERS</span>
                </a>
                <a th:if="${session.currentUser.userType != 'departmenthead'}" th:href="@{/smartgate}"
                    class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
                    <i class="fas fa-door-open mr-3"></i><span>SMARTGATE</span>
                    <span class="tooltip">SMARTGATE</span>
                </a>
             
                <a th:if="${session.currentUser.userType != 'guard'}" th:href="@{/getStudents}" class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
                    <i class="fas fa-list mr-3"></i><span>STUDENT LIST</span>
                    <span class="tooltip">STUDENT LIST</span>
                </a>
				<a th:if="${session.currentUser.userType != 'departmenthead'}" th:href="@{/getVisitors}" class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
				                   <i class="fas fa-list mr-3"></i><span>VISITORS LIST</span>
				                   <span class="tooltip">VISITORS LIST</span>
				               </a>
                <div class="sidebar-nav-item">
                    <a href="#" class="flex items-center p-2 text-white hover:bg-gray-700 rounded group" onclick="toggleHistorySubmenu(event)">
                        <i class="fas fa-history mr-3"></i><span>HISTORY</span>
                        <i class="fas fa-chevron-down ml-auto transition-transform duration-300" id="historyChevron"></i>
                        <span class="tooltip">HISTORY</span>
                    </a>
                    <div id="historySubmenu" class="pl-8 transition-all duration-300 overflow-hidden hidden">
						<form th:action="@{/getStudentLogs}" method="post">
                        <button th:if="${session.currentUser.userType != 'guard'}" class="block p-2 text-white hover:bg-gray-700 rounded relative group">
                            <i class="fas fa-user-graduate mr-2"></i><span class="submenu-text">Student Log</span>
                        </button>
						</form>
						<form th:action="@{/getVisitorLogs}" method="post">
                        <button th:if="${session.currentUser.userType != 'departmenthead'}" class="block p-2 text-white hover:bg-gray-700 rounded relative group">
                            <i class="fas fa-user-tie mr-2"></i><span class="submenu-text">Visitors Log</span>
                        </button>
						</form>
                    </div>
                </div>
 
                <a href="#" class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
                    <i class="fas fa-info-circle mr-3"></i><span>ABOUT US</span>
                    <span class="tooltip">ABOUT US</span>
                </a>
				<div id="hasNotif" style="display: none;">
				    <a href="#" class="sidebar-nav-item flex items-center p-1 text-white hover:bg-gray-700 rounded-lg transition duration-300 glow-animation">
				        <form th:action="@{/getSecurityAlerts}" method="get">
				            <button class="block p-2 rounded-lg relative group transition duration-300 ">
				            <i class="fas fa-bell mr-2 text-lg"></i>
				            <span class="font-bold text-md">SECURITY ALERT</span>
				            <span class="tooltip">SECURITY ALERT</span>
				            <input type="hidden" name="notif" value="hasNotif">
				            </button>
				            <div id="notifText" class="absolute top-0 right-0 bg-red-500 text-white rounded-full text-xs px-3 py-1 font-bold">!</div>
				       </form>
				    
				</a>
				</div>
				<div id="noNotif">
                <a href="#" class="sidebar-nav-item flex items-center p-2 text-white hover:bg-gray-700 rounded group">
					
						<form th:action="@{/getSecurityAlerts}" method="get">
							<button class="block p-2 text-white hover:bg-gray-700 rounded relative group">
		                    <i class="fas fa-bell mr-3"></i><span>SECURITY ALERT</span>
		                    <span class="tooltip">SECURITY ALERT</span>
		                    <input type="hidden" name="notif" value="notif">
		                    </button>
		               </form>
                    
                </a>
                </div>
            </nav>
            <!-- Toggle Button -->
            <button id="sidebar-toggle" class="toggle-bar focus:outline-none relative flex items-center justify-center">
                <i class="fas fa-toggle-on toggle-icon"></i>
                <span class="ml-2">Toggle Sidebar</span>
                <span class="tooltip">Toggle Sidebar</span>
            </button>
            <!-- Footer Section -->
            <div class="mt-auto p-4 text-center footer-border">
                <p class="footer-text-full text-gray-500 text-sm">&copy; 2024 TagoyGroup. All rights reserved.</p>
                <p class="footer-text-collapsed text-gray-500 text-sm hidden">&copy; 2024</p>
            </div>
        </div>

        <div id="main-content" class="flex-1 mb-0 animate-fade-in ">
            <div
                class="top-bar bg-white border-b border-gray-300 ml-10 mr-10 shadow-md flex items-center justify-between p-4 min-h-[64px]">
                <!-- Dashboard Text -->
                <div class="relative overflow-hidden w-max">
                    <span class="text-lg font-extrabold text-gray-900 border-r-4 border-gray-900 pr-2 whitespace-nowrap typing-text">
                        SMARTGATE
                    </span>
                </div>
                
                
			<div class="relative ">
			    <button id="power-button" class="icon-button text-gray-600 hover:text-gray-800">
			        <i class="fas fa-power-off text-2xl"></i>
			    </button>
			
			    <div id="dropdown-menu" class="dropdown-menu">
			        <form th:action="@{/manualOpenClose}" method="post">
			            <button type="submit" name="command" value="open" class="flex items-center p-2 text-gray-700 hover:bg-gray-100 relative">
			                <i class="fas fa-door-open text-2xl text-green-600 mr-2"></i>
			                 
			                <span class="tooltip">Open Gate</span>
			            </button>
			            <button type="submit" id="closedBut" name="command" value="close" class="flex items-center p-2 text-gray-700 hover:bg-gray-100 relative">
			                <i class="fas fa-door-closed text-2xl text-red-600 mr-2"></i>
			                
			                <span class="tooltip">Close Gate</span>
			            </button>
			        </form>
			        <a th:href="@{/logout}"  class="flex items-center p-2 text-gray-700 hover:bg-gray-100 relative">
			            <i class="fas fa-sign-out-alt text-2xl text-blue-600 mr-2"></i>
			           
			            <span class="tooltip">Log Out</span>
			        </a>
			    </div>
			</div>
            </div>


	<div class="flex flex-col justify-center items-center p-4 md:p-8 space-y-8">
	    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-4 text-center font-poppins">
	        <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500">
	            SmartGate Analytics Dashboard
	        </span>
	    </h1>

	    <div class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-4 gap-6">
	        <div class="bg-gradient-to-br from-blue-100 to-blue-200 p-6 rounded-lg shadow-lg">
	            <h3 class="text-2xl font-bold mb-2 text-blue-600">Students</h3>
	            <p class="text-4xl font-semibold" id="totalLogs" th:text="${session.getStudentsCount}"></p>
	        </div>
	        <div class="bg-gradient-to-br from-green-100 to-green-200 p-6 rounded-lg shadow-lg">
	            <h3 class="text-2xl font-bold mb-2 text-green-600" >Registered Visitors</h3>
	            <p class="text-4xl font-semibold" id="mostActiveCode" th:text="${session.getVisitorsCount}"></p>
	        </div>
	        <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-lg shadow-lg">
	            <h3 class="text-2xl font-bold mb-2 text-purple-600">Total Student's Logs</h3>
	            <p class="text-4xl font-semibold" id="totalStudentsLogs"></p>
	        </div>
	        <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-6 rounded-lg shadow-lg">
	            <h3 class="text-2xl font-bold mb-2 text-purple-600">Total Visitor's Logs</h3>
	            <p class="text-4xl font-semibold" id="totalVisitorsLogs"></p>
	        </div>
	    </div>

	<div class="flex flex-wrap w-full">
    <div class="w-full max-w-6xl bg-white rounded-lg shadow-2xl p-4 md:p-6 mx-auto">
        <!-- Flexbox Container to hold two charts side by side -->
        <div class="flex flex-wrap -mx-2">
            <!-- First Chart Container -->
            <div class="w-full md:w-1/2 px-2">
                <div id="container" class="w-full h-[400px]"></div>
            </div>
            <!-- Second Chart Container -->
            <div class="w-full md:w-1/2 px-2">
                <div id="container2" class="w-full h-[400px]"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
    var userProgramCode = /*[[${session.currentUser.programCode}]]*/ ''; 
    var userType = /*[[${session.currentUser.userType}]]*/ ''; 
    var chart1;
    var categories1 = [];
    var data1 = [];

    // Decide which data to fetch based on the user's type
    function fetchData() {
        const url = userType === 'departmenthead' 
            ? '/getTotalStudentsByYearLevel' 
            : '/getTotalStudentsByProgramCode';
        
        fetch(url)
            .then(response => response.json())
            .then(rawData => {
                if (userType === 'departmenthead') {
					// Add this line

                    categories1 = rawData.map(item => {
						console.log("year Level: "+item.yearLevel); 
                        switch (item.yearLevel) {
                            case "1": return '1st Year'; // Numeric comparison
                            case "2": return '2nd Year';
                            case "3": return '3rd Year';
                            case "4": return '4th Year';
                            default: return 'Unknown Year';
                        }
                    });
                } else {
                    categories1 = rawData.map(item => item.programCode);
                }

                data1 = rawData.map(item => ({
                    y: item.count,
                    color: userType === 'departmenthead' ? getColorForYearLevel(item.yearLevel) : getColorForProgramCode(item.programCode)
                }));

                initializeOrUpdateChart(userType === 'departmenthead' ? `${userProgramCode} Students inside the campus by Year Level` : 'Students inside the campus by Program Code');
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    var socket = new SockJS('/ws');
    var stompClient = Stomp.over(socket);
    
    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/entrants', function(data) {
            const entrants = JSON.parse(data.body);
            // Handle the received data
            Swal.fire({
                toast: true,
                position: 'center',
                width: '1200px',
                padding: '0',
                background: '#ffffff',
                showConfirmButton: false,
                timer: 10000,
                timerProgressBar: true,
                html: `
                    <div class="bg-gradient-to-r from-teal-500 to-blue-600 h-64 relative rounded-t-xl shadow-lg">
                        <img src="/images/bcc.jpg" alt="Cover Photo" class="w-full h-full object-cover opacity-50 rounded-t-xl">
                    </div>
                    <div class="relative flex flex-col items-center -mt-32 px-8 pb-8">
                        <img src="${entrants.imgUrl}" alt="Profile Picture" class="w-64 h-64 rounded-full border-8 border-white shadow-2xl object-cover">
                        <div class="mt-8 text-center">
                            <p class="text-5xl font-bold text-gray-800">${entrants.successMessage.replace(/\n/g, '<br>')}</p>
                            <p class="text-2xl text-gray-600 mt-2">Day: ${entrants.time}</p>
                            <p class="text-2xl text-gray-600 mt-1">Year: ${new Date().getFullYear()}</p>
                        </div>
                    </div>
                `
            });
        });
    });

    // Color assignment functions
    function getColorForProgramCode(programCode) {
        switch(programCode) {
            case 'CRIM': return 'red';
            case 'EDUC': return 'blue';
            case 'IS': return 'green';
            case 'OA': return 'orange';
            default: return 'gray';
        }
    }

    function getColorForYearLevel(yearLevel) {
        switch(yearLevel) {
            case "1": return 'red';     // Use numeric comparison
            case "2": return 'blue';
            case "3": return 'green';
            case "4": return 'orange';
            default: return 'gray';
        }
    }

    // Initialize the chart
    function initializeChart(title) {
        chart1 = Highcharts.chart('container', {
            chart: { type: 'column', height: 400 },
            title: { text: title },
            xAxis: { categories: categories1, title: { text: userType === 'departmenthead' ? 'Year Level' : 'Program Code' } },
            yAxis: { title: { text: 'Number of Students' } },
            series: [{ name: 'Students', data: data1 }],
            credits: { enabled: false }
        });
    }

    // Update the chart
    function updateChart(title) {
        chart1.series[0].setData(data1);
        chart1.xAxis[0].setCategories(categories1);
        chart1.setTitle({ text: title });
        chart1.redraw();
    }

    // Initialize or update the chart
    function initializeOrUpdateChart(title) {
        if (chart1) {
            updateChart(title);
        } else {
            initializeChart(title);
        }
    }

    // Initialize first chart
    document.addEventListener('DOMContentLoaded', function () {
        fetchData();
        setInterval(fetchData, 10000); // Update data every 10 seconds
    });




    // Second chart script (for Visitors Status)

    var chart2;
    var categories2 = ['Visitors In Campus', 'Visitors Not In Campus'];
    var data2 = [];

    function fetchData2() {
        fetch('/getTotalVisitorsInCampus')
            .then(response => response.json())
            .then(rawData => {
                data2 = [
                    {y: rawData.currentVisitorsInCampus, color: 'blue'},
                    {y: rawData.visitorsNotInCampus, color: 'red'}
                ];
                console.log("data2 from server: "+rawData.currentVisitorsInCampus);
                initializeOrUpdateChart2();
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function initializeChart2() {
        chart2 = Highcharts.chart('container2', {
            chart: { type: 'column', height: 400 },
            title: { text: 'Current Visitors Status' },
            xAxis: { categories: categories2, title: { text: 'Visitor Status' } },
            yAxis: { title: { text: 'Number of Visitors' } },
            series: [{ name: 'Visitors', data: data2 }],
            credits: { enabled: false }
        });
    }

    function updateChart2() {
        chart2.series[0].setData(data2);
        chart2.redraw();
    }

    function initializeOrUpdateChart2() {
        if (chart2) updateChart2();
        else initializeChart2();
    }

    // Initialize second chart
    document.addEventListener('DOMContentLoaded', function () {
        fetchData2();
        setInterval(fetchData2, 10000);
    });
  

    /*]]>*/
 $(document).ready(function () {
	 function fetchStudentsData() {
        $.ajax({
            url: '/getTotalStudentsLogs',
            method: 'GET',
            success: function(data) {
                $('#totalStudentsLogs').text(data);
                console.log("students hehe", data);
            },
            error: function(error) {
                console.log('Error fetching student data:', error);
            }
        });
    }

    function fetchVisitorsData() {
        $.ajax({
            url: '/getTotalVisitorsLogs',
            method: 'GET',
            success: function(data) {
                $('#totalVisitorsLogs').text(data);
                console.log("visitors hehe", data);
            },
            error: function(error) {
                console.log('Error fetching visitor data:', error);
            }
        });
    }
    function fetchNotif() {
        $.ajax({
            url: '/getNotifications',
            method: 'GET',
            success: function(data) {
                var hasNotif = data.hasNotif;

            // Log or update the UI with the notification status
            console.log("Has Notif Value: ", hasNotif);

            if (hasNotif > 0) {
                $('#hasNotif').css('display', 'block'); // Show the hasNotif div
                $('#noNotif').css('display', 'none');   // Hide the noNotif div
                $('#notifText').text(hasNotif);
            } else {
                $('#hasNotif').css('display', 'none');  // Hide the hasNotif div
                $('#noNotif').css('display', 'block');  // Show the noNotif div
            }
            },
            error: function(error) {
                console.log("errorrrr");
            }
        });
    }
  
fetchNotif()
     fetchVisitorsData();
        fetchStudentsData();
                setInterval(fetchStudentsData, 10000);
        setInterval(fetchVisitorsData, 10000);
        setInterval(fetchNotif, 5000);
});
    // Sidebar and layout management
    document.addEventListener('DOMContentLoaded', function () {
        var sidebar = document.getElementById('sidebar');
        var topBar = document.querySelector('.top-bar');
        var mainContent = document.getElementById('main-content');
        var footerTextFull = document.querySelector('.footer-text-full');
        var footerTextCollapsed = document.querySelector('.footer-text-collapsed');
        var dropdownMenu = document.getElementById('dropdown-menu');
        var powerButton = document.getElementById('power-button');

        // Update layout based on sidebar state
        function updateLayout() {
            const savedState = localStorage.getItem('sidebarState');
            if (savedState === 'minimized') {
                sidebar.classList.add('minimized');
                sidebar.classList.remove('expanded');
                footerTextFull.classList.add('hidden');
                footerTextCollapsed.classList.remove('hidden');
            } else {
                sidebar.classList.remove('minimized');
                sidebar.classList.add('expanded');
                footerTextFull.classList.remove('hidden');
                footerTextCollapsed.classList.add('hidden');
            }

            document.querySelectorAll('.sidebar-expanded').forEach(el => el.classList.toggle('hidden', sidebar.classList.contains('minimized')));
            document.querySelectorAll('.sidebar-collapsed').forEach(el => el.classList.toggle('hidden', !sidebar.classList.contains('minimized')));
            document.querySelectorAll('.toggle-bar span').forEach(el => el.classList.toggle('hidden', sidebar.classList.contains('minimized')));
            topBar.classList.toggle('minimized', sidebar.classList.contains('minimized'));
            mainContent.classList.toggle('minimized', sidebar.classList.contains('minimized'));

            dropdownMenu.classList.remove('show');
            dropdownMenu.classList.add('hide');
            dropdownMenu.style.display = 'none';
        }

        // Call updateLayout on page load
        updateLayout();

        // Save sidebar state
        function saveSidebarState() {
            const isMinimized = sidebar.classList.contains('minimized');
            localStorage.setItem('sidebarState', isMinimized ? 'minimized' : 'expanded');
        }

        // Toggle Sidebar
        document.getElementById('sidebar-toggle').addEventListener('click', function () {
            sidebar.classList.toggle('minimized');
            sidebar.classList.toggle('expanded');
            saveSidebarState();
            updateLayout();
        });

        // Power button dropdown functionality
        powerButton.addEventListener('click', function (event) {
            event.stopPropagation();
            dropdownMenu.classList.toggle('show');
            dropdownMenu.classList.toggle('hide');
            dropdownMenu.style.display = dropdownMenu.classList.contains('show') ? 'block' : 'none';
        });

        // Optional: Close dropdown if clicked outside
        document.addEventListener('click', function (event) {
            if (!powerButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hide');
                dropdownMenu.classList.remove('show');
                dropdownMenu.style.display = 'none';
            }
        });

        // Toggle button functionality
        const button = document.getElementById('toggle-button');
        const circle = document.getElementById('toggle-circle');
        const onText = document.getElementById('on-text');
        const offText = button.querySelector('span.text-gray-700');

        // Load saved state from localStorage
        const isOn = localStorage.getItem('toggleState') === 'on';
        if (isOn) {
            button.classList.add('bg-purple-400');
            circle.classList.add('translate-x-6');
            onText.classList.remove('hidden');
            offText.classList.add('hidden');
        }

        button.addEventListener('click', () => {
            const isOn = button.classList.toggle('bg-purple-400');
            circle.classList.toggle('translate-x-6');
            onText.classList.toggle('hidden');
            offText.classList.toggle('hidden');
            localStorage.setItem('toggleState', isOn ? 'on' : 'off');
        });
    });

    // History submenu functionality
  
    /*]]>*/
</script>


</body>
</html>
